<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html"> 
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="simple-tracker.html">
<dom-module id="my-mfa">
  <template>
    <simple-tracker style="position:absolute" id="tracker"></simple-tracker>

    <style include="my-app-style iron-flex iron-flex-alignment"></style>
    <style include="shared-styles">
      :host {
        padding-bottom:30px;
        display: block;
        --paper-spinner-color: #30CD9A;
        --paper-spinner-stroke-width: 3px;
        
         animation: fadein 2s;
        -moz-animation: fadein 2s; /* Firefox */
        -webkit-animation: fadein 2s; /* Safari and Chrome */
        -o-animation: fadein 2s; /* Opera */
      }
      :host::before{
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-image: url("../images/BG.png");
        background-repeat: no-repeat;
        opacity: 0.4;
        background-position: bottom;
        background-size: contain;
      }
      .login-box{
        padding: 10px 30px;
        color: #757575;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        width:425px;
      }
      
      .btn_login{
        margin:10px 0px 20px;
        background-color: #30CD9A;
        color: white;
        width: 64%
      }

       .btn_back{
        margin:10px 0px 20px;
        background-color: #30CD9A;
        color: white;
      }
      .error{

        color: #F45531;
        padding-top: 15px;
        text-align: center;
        
      }
      .box{ position: relative;}
      .spinner_box{
        position:absolute;
        top: 5px;
        right: 5px;
      }
    </style>

    <div style="margin-top:10px;" class="self-center box login-box">
      <div class="layout horizontal center-justified">
          <div class="self-center">
            <iron-icon class="self-center" style="width:120px;height:120px;color:#30CD9A" icon="lock"></iron-icon>
            <!-- <img style="height:120px;" src="../images/manifest/logo_green_ninja.svg"></img> -->
          </div>
          
          <div style="background-color:#30CD9A; width:3px; margin:0 30px;"></div>

          <div class="layout vertical flex">
            <iron-a11y-keys id="a11y" keys="enter" on-keys-pressed="login_mfa"></iron-a11y-keys>
            <h3>Two-Factor Authentication</h3>
            <span>[[_mfaToSimpleName(mfatype)]]</span>
            <paper-input id="txtCode" label="Code" value="{{mfacode}}" required ></paper-input>
            <div class="horizontal flex">
              <a href="javascript:window.location.reload();" style="text-decoration: none;"><paper-button class="btn_back" raised>Back</paper-button></a>
              <paper-button id="btnContinue"  class="btn_login" raised on-tap='login_mfa'>Continue</paper-button>
            </div>
           
          </div>
      </div>

      <div class="spinner_box flex">
        <paper-spinner-lite id="spinner"></paper-spinner-lite>
      </div>
      <template is="dom-if" if="{{error}}">
        <div id="error" class="error layout self-centered">{{error}}</div>
      </template>
    </div>
  

    <iron-ajax id="ajax"
        url="https://api.robinhood.com/api-token-auth/"
        body='{"username": "{{u}}","password": "{{p}}","mfa_code": "{{mfacode}}"}'
        headers='{"Accept": "application/json", "Content-Type": "application/json", "Access-Control-Allow-Origin": "*"}'
        method="POST"
        handle-as="json"
        on-response="_handleResponse"
        on-error="_handleError"
        debounce-duration="300"
        bubbles>
    </iron-ajax>

  </template>

  <script>
    class MyMfa extends Polymer.Element {
      static get is() { return 'my-mfa'; }
      static get properties() {
        return {
          mfatype: { 
            type: String,
            value: null,
          },
          mfarequired:{
            type: Boolean,
            value: false,
          },
          mfacode: String,
          u:  String,
          p: String,
          mfaTypeName: { 
            type: String,
            value: '',
          },
          error: {
            type: String,
            value: ''
          }
        };

      }
      ready() {
        super.ready();

      };
      login_mfa() {

        if(this.$.txtCode.validate()){
          this.shadowRoot.querySelector('#spinner').active = true;
          this.$.ajax.generateRequest();
        }
        
      }

      _mfaToSimpleName(val) {

        switch (val) {
          case 'sms':
          
          //this.mfaavailable = false;
              return 'Enter code you received via SMS'
            break;
          // case 'app':
          //   return 'Enter the code generated by your authentication app'
          // break;
          case 'app':
            this.$.btnContinue.disabled = true;
            this.$.txtCode.disabled = true;
            //this.mfaavailable = false;
            return 'Robinhood API only supports MFA using SMS for now.'
          break;

          default:
          return 'Enter code';
            break;
        }

      }


      _handleResponse(data) {



          /** GOOGLE ANALYTICS **/
          this.$.tracker.gaCreate('YOUR GOOGLE ANALYTICS TRACKING ID');
          this.$.tracker.gaSetUserId(SHA256(this.u));
          this.$.tracker.gaTrackPageView('MFA Login');
          this.$.tracker.gaTrackEvent('App-Actions', 'MFA Sign-In Success')
          /** GOOGLE ANALYTICS **/

          this.dispatchEvent(new CustomEvent('success', { bubbles: true, composed: true, detail: { token: data.detail.response.token } }));

      };

      _handleError(error) {
      this.shadowRoot.querySelector('#spinner').active = false;
      this.error = error.detail.request.xhr.response.non_field_errors;
      };
    }

    window.customElements.define(MyMfa.is, MyMfa);
  </script>
</dom-module>
